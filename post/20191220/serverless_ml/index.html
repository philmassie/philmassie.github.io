<!DOCTYPE html>
<html lang="en-us">
<head><head>
    <meta name="google-site-verification" content="9vIieCe-Qpd78QOmBl63rGtIVbhY6sYyuxX3j8XWBA4" />
    <meta name="baidu-site-verification" content="LRrmH41lz7" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Kabelsalat">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://philmassie.github.io//post/20191220/serverless_ml/2019-12-17_17-44-47.png">
    <meta property="twitter:image" content="https://philmassie.github.io//post/20191220/serverless_ml/2019-12-17_17-44-47.png" />
    

    
    <meta name="title" content="Serverless ML." />
    <meta property="og:title" content="Serverless ML." />
    <meta property="twitter:title" content="Serverless ML." />
    

    
    <meta name="description" content="Wrangling data and training models can feel a little... disconnected. In this post I&#39;ll walk through deploying an ML model in the cloud. It&#39;s quick, easy and free (I think).">
    <meta property="og:description" content="Wrangling data and training models can feel a little... disconnected. In this post I&#39;ll walk through deploying an ML model in the cloud. It&#39;s quick, easy and free (I think)." />
    <meta property="twitter:description" content="Wrangling data and training models can feel a little... disconnected. In this post I&#39;ll walk through deploying an ML model in the cloud. It&#39;s quick, easy and free (I think)." />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="data science, predictive analytics, machine learning, visualisation, photography, spark, python, R, scala">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Serverless ML.-Kabelsalat | Phil Massie&#39;s blog</title>

    <link rel="canonical" href="/post/20191220/serverless_ml/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/syntax.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>
	
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/docco.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>
</head>

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kabelsalat</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/post/20191220/serverless_ml/2019-12-17_17-44-47.png')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/python" title="python">
                            python
                        </a>
                        
                        <a class="tag" href="/tags/aws" title="aws">
                            aws
                        </a>
                        
                        <a class="tag" href="/tags/lambdas" title="lambdas">
                            lambdas
                        </a>
                        
                        <a class="tag" href="/tags/cloud-functions" title="cloud functions">
                            cloud functions
                        </a>
                        
                        <a class="tag" href="/tags/machine-learning" title="machine learning">
                            machine learning
                        </a>
                        
                        <a class="tag" href="/tags/data-science" title="data science">
                            data science
                        </a>
                        
                        <a class="tag" href="/tags/api" title="api">
                            api
                        </a>
                        
                    </div>
                    <h1>Serverless ML.</h1>
                    <h2 class="subheading">Bring your models to life with AWS Lambdas.</h2>
                    <span class="meta">
			Posted by 
			
			    Philip Massie
			 
			on 
			Tuesday, December 17, 2019
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                
                <!-- Style for changing title colour depending on photo -->
<style>
   div.post-heading div.tags,
   div.post-heading h1, 
   div.post-heading h2 {
    color: #1a0d00;
    text-shadow: 0px 0px 2px grey;
  }
</style>
<h2 id="introduction">Introduction</h2>
<p>Working day in and day out wrangling data sets, engineering interesting features and testing and training heaps and heaps of models can leave you feeling a bit disconnected from real-world systems. Well, it can for me at any rate. Recently I've spent time with some software engineers who've helped me understand how ML models can be deployed in the cloud by leveraging severless architectures, at little or no cost. As a result, models or ensembles of models can fit into larger systems via simple API calls.</p>
<p>Using AWS Lambdas, we dont need to keep costly EC2 instances up and running 24/7. Lambdas spin up really fast as required. (Google Cloud have a similar offering called Cloud Functions but here I'll be focussing on the AWS offering.) In the background of course they are all running on EC2 servers but Lambdas are so abstracted away from them that you dont need to bother about the EC2s. There are many good reasons to think go serverless but I dont want to run an advert. <a href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html">You can read more here</a></p>
<p>A Lambda is essentially a small fast container preconfigured with one of a number of different runtimes. These include:</p>
<ul>
<li>several Node.js variants</li>
<li>Go 1.x</li>
<li>Various Python releases</li>
<li><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html">And numerous others</a></li>
</ul>
<p>As a data scientist I work principally with Python these days and in this tutorial I'll walk you through deploying a simple ML model in an AWS Lambda. There is an accompanying github repo <a href="https://github.com/philmassie/serverless_ml.git">here</a> which includes all the code you'll need along with the model, data and training data.</p>
<h3 id="the-model">The Model</h3>
<p>This is not an exercise in training a great model. As a use case I used historical weather data for Cape Town to train a model to predict the likelihood of rain tomorrow based on Cape Town's history. you can feed it any city in the world, and it will predict whether it will rain there tomorrow based on Cape Town's history. That's ok, it's not really the point.</p>
<h3 id="the-point">The Point</h3>
<p>If you are unfamiliar with Lambdas or dissilusioned with the costs of housing your Docker Containers on EC2 instances, hopefully this will give you an idea of how cheap and easy it can be to think about larger more complex systems of models and code. With luck your creative juices will be stimulated.</p>
<h2 id="requirements">Requirements</h2>
<p>This looks a little tedious but is worth figuring out. Much of it you will only need to do once. I'll gloss over some things here like AWS execution roles and key management. Additionally the tutorial will use both the AWS web console and the CLI. If youre unfamiliar with the CLI, hopefully this will be an easy introduction to it.</p>
<h3 id="python-36">Python 3.6</h3>
<p>We will use the Python 3.6 Lambda runtime environment as this runtime comes with a preconfigured layer containing scipy/numpy. Because these packages have OS dependencies not present in the Lambda environment by default, this layer is critical for us to use any of the low level math functions such as those in SKLearn. I see that the Python 3.7 runtime also has a scipy/numpy layer now!</p>
<h3 id="docker">Docker</h3>
<p>In order to build layers we need to install Python packages locally in an environment that matches the Lambda's remote environment. Solution: Docker <a href="https://www.google.com/search?q=install+docker">how to install</a></p>
<p>If you're in Ubuntu, this should get you going:</p>
<pre><code>sudo apt-get remove docker docker-engine docker.io
sudo apt install docker.io
sudo systemctl start docker
sudo systemctl enable docker
</code></pre><h3 id="github-repo">Github repo</h3>
<p>A <a href="https://github.com/philmassie/serverless_ml.git">github repo</a> is available for this tutorial. Directory structure is important and I'll assume youre running commands from the project root.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">- project root/
  ├-layers/
  <span class="p">|</span> ├-02_dependencies/
  <span class="p">|</span> <span class="p">|</span> └-requirements.txt
  <span class="p">|</span> <span class="p">|</span>-03_rain_model/
  <span class="p">|</span> <span class="p">|</span> ├-models/
  <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> └-rf_rain.pkl 
  <span class="p">|</span> <span class="p">|</span> └-keys.csv.template 
  <span class="p">|</span> ├-zips/
  <span class="p">|</span> └-model_training/
  ├-readme.md
  └-rain_forecast.py
</code></pre></div><h3 id="darksky">Darksky</h3>
<p>You'll need a free account here in order to query weather data.
Sign up at <a href="https://darksky.net/dev">https://darksky.net/dev</a>. After signup and login, your home page should show you your secret key. Store this in <code>layers/03_rain_model/keys.csv</code>.</p>
<h3 id="locationiq">LocationIQ</h3>
<p>Sign up for a free account at Location IQ <a href="https://locationiq.com">https://locationiq.com</a> for geocoding. Create an <strong>Access Token</strong> and store this in <code>layers/03_rain_model/keys.csv</code>.</p>
<h2 id="aws-setup">AWS Setup</h2>
<h3 id="account">Account</h3>
<p>If you haven't already, set up your free AWS account.</p>
<h3 id="install-aws-cli">Install AWS CLI</h3>
<p>AWS CLI provides command line access to AWS. You need to install it, typically with pip, and configure it for use with your AWS account.</p>
<p>TLDR Ubuntu version <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv1.html">check these instructions for other systems and troubleshooting</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># install</span>
pip3 install awscli --upgrade --user
<span class="c1"># check (might need to log in to ubuntu again)</span>
aws --version
</code></pre></div><h4 id="configure">Configure</h4>
<p>We'll need to use the console to configure AWS CLI.</p>
<p>Logged in to the AWS console:</p>
<ul>
<li>Top right, click the dropdown under your name &gt; My Security Credentials</li>
<li>Select &ldquo;Access keys (access key ID and secret access key)&rdquo;</li>
<li>&ldquo;Click Create New Access Key&rdquo;</li>
<li>Download the csv with your key and secret key and save somewhere safe</li>
</ul>
<p>Back to your terminal (<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html#cli-quick-configuration">detailed instructions</a>):</p>
<pre><code>$ aws configure
AWS Access Key ID [None]: ABABABABAEXAMPLE
AWS Secret Access Key [None]:CDCDCDCDCDCDCDCDCDCDCEXAMPLEKEY
Default region name [None]: us-west-2
Default output format [None]: json
</code></pre><h3 id="create-an-s3-bucket-for-the-project">Create an S3 bucket for the project</h3>
<p>Back to the web console, S3 section, create an empty bucket for this project. Bucket names have to be unique across all buckets so call this something you can remember. You can of course also get this done with the CLI.</p>
<p>I'll call mine <code>severless-ml-tutorial</code> in US West Oregon (to match our config). you'll need to adjust the code below to match this name.</p>
<blockquote>
<p>I think this is the only place you could potentially incur some costs. S3 storage is not free, although at this scale it is very cheap. After building your layers delete this bucket to save potential costs. I have a couple buckets with a few MB inside and I havent incurred a cost yet. It's a little confusing.</p>
</blockquote>
<p><img src="2019-12-17_17-28-38.png" alt=""><!-- --></p>
<h1 id="lambdas">Lambdas</h1>
<p>Still there? well done! Ok lets build our first simple Lambda. We will expand on it later.</p>
<h3 id="create-a-lambda">Create a Lambda</h3>
<ul>
<li>In the AWS Console, click &lsquo;Services&rsquo; &gt; &lsquo;Lambda&rsquo;.</li>
<li>Click on &lsquo;Create function&rsquo; to create a new Lambda function.
<ul>
<li>Call it <code>severless-ml-lambda</code> and select the Python 3.6 Runtime. Leave the Permissions options set to default.</li>
<li>Click on &lsquo;Create function&rsquo; at the bottom.</li>
</ul>
</li>
<li>Your Lambda will be created and it's properties screen will open.</li>
</ul>
<h3 id="add-an-api-gateway-trigger">Add an API Gateway trigger</h3>
<p>Now we will configure an http gateway where we can interact with our new Lambda.</p>
<ul>
<li>In the Designer panel click &lsquo;Add trigger&rsquo;
<ul>
<li>Select &lsquo;API gateway&rsquo;</li>
<li>API dropdown &gt; &lsquo;Create new API&rsquo;</li>
<li>From &lsquo;Choose a template&rsquo; select &lsquo;Rest API&rsquo;</li>
<li>Security dropdown &gt; Open</li>
<li>Additional settings - default</li>
<li>click &ldquo;Add&rdquo;</li>
</ul>
</li>
</ul>
<h3 id="add-a-test-event">Add a test event</h3>
<p>Now we add an example query so that we can test how our Lambda will respond to API calls. We will be sending our Lambda the name of a city so lets set up a test event to do that.</p>
<ul>
<li>At the top of the screen in the &lsquo;select a test event&rsquo; dropdown select configure test events</li>
<li>enter a name, eg. &lsquo;WeatherTest&rsquo;</li>
<li>enter the following json, mimicking an https event submitting the &ldquo;city&rdquo; string &ldquo;Los Angeles&rdquo;.</li>
</ul>
<pre><code>{
  &quot;httpMethod&quot;: &quot;GET&quot;,
  &quot;queryStringParameters&quot;: {
    &quot;city&quot;: &quot;Los Angeles&quot;
  }
}
</code></pre><h3 id="add-some-code">Add some code</h3>
<p>Now at last we can add some code. This is extremely simple, It assigns the incoming string to a variable, prints it out and returns a formatted HTML string containing the string.</p>
<ul>
<li>Designer panel
<ul>
<li>highlight your Lambda name</li>
</ul>
</li>
<li>Scroll down to Function code panel
<ul>
<li>Paste the following code into the code block (we'll need all those libraries later):</li>
</ul>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-Python" data-lang="Python"><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.io.json</span> <span class="kn">import</span> <span class="n">json_normalize</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">display.max_columns</span><span class="s2">&#34;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">display.width</span><span class="s2">&#34;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">display.max_colwidth</span><span class="s2">&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span><span class="p">:</span>
    <span class="c1"># 01 Code start</span>
    <span class="c1">#---------------</span>
    <span class="c1"># get the city name from the query string</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">city</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">queryStringParameters</span><span class="s2">&#34;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">city</span><span class="s2">&#34;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">city</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">Cape Town</span><span class="s2">&#34;</span>
    
    <span class="c1"># print the city value</span>
    <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">city: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">city</span><span class="p">)</span>

    <span class="c1"># build a success string</span>
    <span class="n">success</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&lt;h1&gt;City: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">city</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&lt;/h1&gt;</span><span class="s2">&#34;</span>
    
    <span class="c1"># send the output to the browser</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">statusCode</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">body</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">headers</span><span class="s2">&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Content-Type</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">text/html</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div><ul>
<li>Near the top of the page again, click Save and then Test.
<ul>
<li>with some luck your Lambda just executed the payload you sent with your WeatherTest json.</li>
<li>The result should show up in the green panel near the top of the page.</li>
<li>You can see the result of the Python print function in there too.</li>
</ul>
</li>
</ul>
<p><img src="2019-12-17_17-37-31.png" alt=""></p>
<ul>
<li>Test the Lambda as a URL
<ul>
<li>In the Designer panel click the API Gateway block, scroll down to the API Gateway panel url and click the url next to API Endpoint.</li>
<li>Add <code>?city=Hong Kong</code> to the end of the url. hit enter and you should see the page contents update to reflect this new querystring.</li>
</ul>
</li>
</ul>
<p>You have now got a simple Lambda, accessible via a URL, you can send it a payload, and it can process and return the payload, in this case as an HTTP response.</p>
<h1 id="extenting-the-lambda">Extenting the Lambda</h1>
<h3 id="layers">layers</h3>
<p>Before we add more code to do more interesting things, lets make our Lambda architecture a little more powerful. We can do this by adding layers. Layers are simply additional resources youre including in your Lambda container - There are size constraints to deal with so dont go too crazy.</p>
<p>After this section we can get back to the code and extend the Lambda.
If you have the <a href="https://github.com/philmassie/serverless_ml.git">github repo</a> you'll see that I have the files required to build each layer nested within a layers directory.</p>
<p>Typically we need to collate the contents of each layer, upload them to S3, compile the contents into Lambda layers and then attach the layers to our Lambda.</p>
<h3 id="01-scipynumpy-layer">01 Scipy/Numpy layer</h3>
<p>This layer is precompiled by AWS and includes not only python libraries but also system libraries that we need to use. This is a really difficult layer to build for yourself but thankfully AWS have done the heavy lifting for us. We dont need to build this layer.</p>
<p><img src="2019-12-17_17-39-17.png" alt=""></p>
<h3 id="02-dependencies-layer">02 Dependencies layer</h3>
<p>This layer will include all of the required Python libraries betond those installed by default. We will collate the contents of this layer on our local machine using a docker container that resembles the Lambda environment, namely lambci.
From within lambci container, we can use pip to install the libraries to a local directory, outside of the container. We then use this directory to build our new layer.</p>
<p>In the terminal, from the project root:</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">docker run --rm -it -v <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/layers/02_dependencies:/var/task lambci/lambda:build-python3.6 bash
<span class="c1"># From the docker container, install the python packages</span>
pip install -r requirements.txt --target python/lib/python3.6/site-packages/ --no-deps --ignore-installed
<span class="nb">exit</span>
</code></pre></div><p>If that worked as expected you should now see a &lsquo;python&rsquo; directory inside your &lsquo;02_dependencies&rsquo; layer directory.</p>
<h4 id="zip-the-layer-contents">Zip the layer contents</h4>
<p>We need to compress the layer contents in preparation for uploading to S3.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell"><span class="c1"># clear any old versions first</span>
rm layers/zips/02_dependencies.zip
<span class="nb">pushd</span> layers/02_dependencies
zip -r ../zips/02_dependencies.zip python
<span class="nb">popd</span>
</code></pre></div><h4 id="upload-the-layer-to-s3">Upload the layer to S3</h4>
<p>Using the AWS CLI instead of the web Console, sync the contents of your zips directory with a location in S3.
It's a good idea to keep the web console open to see that what youre doing is having the desired effect.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">aws s3 sync layers/zips s3://severless-ml-tutorial/lambdas/layers --delete
</code></pre></div><h4 id="buildupdate-layer-02-dependencies">Build/update layer 02_dependencies</h4>
<p>Now we can use the uploaded zip file to update or create a Lambda layer that can be used in any Python 3.6 Lambda. Remember to change the name of your bucket next to S3Bucket=.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">aws lambda publish-layer-version --layer-name weather_02_dependencies --description <span class="s2">&#34;dependencies layer&#34;</span> --content <span class="nv">S3Bucket</span><span class="o">=</span>severless-ml-tutorial,S3Key<span class="o">=</span>lambdas/layers/02_dependencies.zip --compatible-runtimes python3.6
</code></pre></div><h3 id="03-rain-model-layer">03 Rain model layer</h3>
<p>The files for this layer already exist on the <code>layers/03_rain_model/</code> directory, so no Docker hijinks needed here.
You need to put your api keys into the file called <code>keys.csv.template</code> and rename it to <code>keys.csv</code>.</p>
<blockquote>
<p>Despite the name and main purpose of the layer, I'll include the API keys in addition to the model object.
NB This is NOT the correct/secure way to manage keys in the cloud.</p>
</blockquote>
<blockquote>
<p><strong>DON'T DO THIS WITH IMPORTANT KEYS!</strong></p>
</blockquote>
<h4 id="zip-the-layer-contents-1">Zip the layer contents</h4>
<p>We need to compress the layer contents in preparation for uploading to S3.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># clear any old versions first</span>
rm layers/zips/03_rain_model.zip
<span class="nb">pushd</span> layers/03_rain_model/
zip -r ../zips/03_rain_model.zip .
<span class="nb">popd</span>
</code></pre></div><h4 id="upload-the-layer-to-s3-1">Upload the layer to S3</h4>
<p>As before, upload the layer contents to S3&hellip;</p>
<pre><code>aws s3 sync layers/zips s3://severless-ml-tutorial/lambdas/layers --delete
</code></pre><h4 id="buildupdate-layer-03-rain-model">Build/update layer 03_rain_model</h4>
<p>&hellip; and build the layer. Remember to change your bucket name here.</p>
<pre><code>aws lambda publish-layer-version --layer-name weather_03_model --description &quot;model layer&quot; --content S3Bucket=severless-ml-tutorial,S3Key=lambdas/layers/03_rain_model.zip --compatible-runtimes python3.6
</code></pre><h3 id="check-that-layers-have-been-succesfully-created">Check that layers have been succesfully created</h3>
<p>Use the AWS web console to make sure layers exist.</p>
<ul>
<li>S3 section
<ul>
<li>Confirm that layer zip files exist in S3.</li>
</ul>
</li>
<li>Lambdas section
<ul>
<li>Confirm that new layers have been created.</li>
<li>Services &gt; Lambda &gt; Layers &gt; &hellip;</li>
<li>Each time you update an existing layer it will get a new version.</li>
</ul>
</li>
</ul>
<h3 id="add-the-new-layers-to-your-lambda">Add the new Layers to your Lambda</h3>
<p>We will add all the required layers to our Lambda and then we're done with the set-up.</p>
<ul>
<li>In the web console, open your Lambda
<ul>
<li>Services &gt; Lambda &gt; click serverless-ml-lambda</li>
</ul>
</li>
<li>In the Designer pane, click &lsquo;Layers&rsquo;.</li>
<li>Scroll down to the Layers pane and using the &lsquo;Add a layer button, add the latest versions of the following 3 layers:
<ol>
<li>AWSLambda-Python36-SciPy1x version 2
<ul>
<li>Python 3.6 numpy/scipy + OS deps layer)</li>
</ul>
</li>
<li>weather_02_dependencies
<ul>
<li>Our Python libraries dependencies weather_02_dependencies</li>
</ul>
</li>
<li>weather_03_model
<ul>
<li>Our random forest model and keys file layer weather_02_model</li>
</ul>
</li>
</ol>
</li>
</ul>
<p>Dont forget to click Save!</p>
<p>That's it for the set-up. If you've gotten this far well done! Writing this out, it seems very long. All that's left now is to build out the code!</p>
<h1 id="build-out-the-code">Build out the code</h1>
<p>Each of the following steps expands on the code from the previous step. To follow along and see how the functionality grows, add each block of code to the bottom of the previous, overwriting the previous code's return braces. After updating and saving at each step, reload the API endpoint URL and submit a different city if you'd like.</p>
<p>Alternatively, find the full code in severless-ml-lambda.py.</p>
<h3 id="add-geolocation">Add geolocation</h3>
<p>This block loads up the API keys and uses the LoationIQ key to geocode the city you submitted. These results are printed and returned via http.</p>
<div class="highlight"><pre class="chroma"><code class="language-Python" data-lang="Python">    <span class="c1"># paste over previous return {...}</span>

    <span class="c1"># 02 Code start</span>
    <span class="c1">#---------------</span>
    <span class="c1"># retrieve our API keys for LocationIQ and DarkSky</span>
    <span class="c1"># this is definitely not the best way to store keys. But these aren&#39;t too important so it doesn&#39;t matter</span>
    <span class="n">keys</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">/opt/keys.csv</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="c1"># keys = pd.read_csv(&#34;layers/03_rain_model/keys.csv&#34;) # local keys - put yours here</span>
    <span class="n">lociq_api</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">lociq_api</span><span class="s2">&#34;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">darksky_api</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">darksky_api</span><span class="s2">&#34;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">LocationIQ API key: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">lociq_api</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">DarkSky API key: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">darksky_api</span><span class="p">)</span>

    <span class="c1"># use LocationIQ to do geolocation</span>
    <span class="n">lociq</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">https://eu1.locationiq.com/v1/search.php?key=</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">lociq_api</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&amp;q=</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">city</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&amp;format=json</span><span class="s2">&#34;</span>
    <span class="n">lociq_info</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lociq</span><span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lociq_info</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">lat</span><span class="s2">&#34;</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lociq_info</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">lon</span><span class="s2">&#34;</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">Lat: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">Lon: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="p">)</span>

    <span class="c1"># build a success string</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">success</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">Latitude: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&lt;/br&gt;Longitude: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&lt;/br&gt;</span><span class="s2">&#34;</span>
    
    <span class="c1"># overwrite this block with next step.</span>
    <span class="c1"># send the output to the browser</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">statusCode</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">body</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">headers</span><span class="s2">&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Content-Type</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">text/html</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div><h3 id="add-weather-query">Add weather query</h3>
<p>This code takes the DarkSky key and the LocationIQ GPS co-ordinates and returns the current weather conditions for the city you submitted.</p>
<div class="highlight"><pre class="chroma"><code class="language-Python" data-lang="Python">    <span class="c1"># paste over previous return {...}</span>

    <span class="c1"># 03 Code start</span>
    <span class="c1">#---------------</span>
    <span class="c1"># Retrieve the current weather conditions from Dark Sky</span>
    <span class="n">darksky</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">https://api.darksky.net/forecast/</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">darksky_api</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">/</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">,</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">?exclude=minutely,daily,hourly,alerts,flags</span><span class="s2">&#34;</span>
    <span class="n">darksky_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">darksky</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">currently</span><span class="s2">&#34;</span><span class="p">]</span>
    <span class="n">weather_df</span> <span class="o">=</span> <span class="n">json_normalize</span><span class="p">(</span><span class="n">darksky_response</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">_</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">Weather:</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">weather_df</span><span class="p">)</span>
    
    <span class="c1"># build a success string</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">success</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&lt;h2&gt;Current weather&lt;/h2&gt;</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">weather_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&lt;/br&gt;&lt;/br&gt;</span><span class="s2">&#34;</span>
    
    <span class="c1"># overwrite this block with next step.</span>
    <span class="c1"># send the output to the browser</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">statusCode</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">body</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">headers</span><span class="s2">&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Content-Type</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">text/html</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div><h3 id="add-model-prediction">Add model prediction</h3>
<p>Add this code block to load up the model you pushed in layer 3 and make a prediction about weather it might rain tomorrow.</p>
<p>NB you will run into memory errors when you test this. Scroll down to Basic settings panel and increase your Lambda's memory to 1024 Mb. While youre there increase your timeout to 10 sec.</p>
<div class="highlight"><pre class="chroma"><code class="language-Python" data-lang="Python">    <span class="c1"># paste over previous return {...}</span>

    <span class="c1"># 04 Code start</span>
    <span class="c1">#---------------</span>
    <span class="c1"># prep the data for the model, load the model and make a prediction</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">weather_df</span><span class="p">[</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">apparentTemperature</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">cloudCover</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">dewPoint</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">humidity</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ozone</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">pressure</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">temperature</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">uvIndex</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">visibility</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">windBearing</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">windGust</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">windSpeed</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">]</span>

    <span class="c1"># load the model from disk, do prediction</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">/opt/models/rf_rain.pkl</span><span class="s2">&#34;</span>
    <span class="c1"># filename = &#34;layers/03_rain_model/models/rf_rain.pkl&#34; local copy</span>
    <span class="n">rf_rain</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">rb</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">)</span>

    <span class="c1"># predictions</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">rf_rain</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">p_rain</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">rf_rain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">pred_str</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">No</span><span class="s2">&#34;</span> <span class="k">if</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">Yes</span><span class="s2">&#34;</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">Rain? </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">pred_str</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">Rain probability: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_rain</span><span class="p">)</span><span class="p">)</span>

    <span class="c1"># build a success string</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">success</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">Will it rain tomorrow? </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">pred_str</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&lt;/br&gt;probability of rain: </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_rain</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&lt;/br&gt;</span><span class="s2">&#34;</span>
    
    <span class="c1"># overwrite this block with next step.</span>
    <span class="c1"># send the output to the browsert</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">statusCode</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">body</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">headers</span><span class="s2">&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Content-Type</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">text/html</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div><h3 id="add-writing-to-s3">Add writing to S3</h3>
<p>This last step writes the results of each query out to S3. It's really just a little extra to show how simple it can be to intract with the AWS infrastructure from Python and Lambdas.</p>
<div class="highlight"><pre class="chroma"><code class="language-Python" data-lang="Python">    <span class="c1"># paste over previous return {...}</span>

    <span class="c1"># 05 Code start</span>
    <span class="c1">#---------------</span>
    <span class="c1"># write something about the query to DynamoDB and S3</span>
    <span class="c1"># prep the data we want to write</span>
    <span class="c1"># store the timestamp</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">weather_df</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">time</span><span class="s2">&#34;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">)</span>
    <span class="c1"># add predictions to df and make legible time</span>
    <span class="n">weather_df</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">datetime</span><span class="s2">&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">weather_df</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">time</span><span class="s2">&#34;</span><span class="p">]</span><span class="p">)</span><span class="p">)</span>
    <span class="n">weather_df</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">prob_rain</span><span class="s2">&#34;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">p_rain</span>
    <span class="n">weather_df</span><span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">pred_rain</span><span class="s2">&#34;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pred_str</span>   

    <span class="c1"># convert pandas to json</span>
    <span class="n">weather_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">weather_df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">records</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span> <span class="n">parse_float</span><span class="o">=</span><span class="n">Decimal</span><span class="p">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
        <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
            <span class="n">partition_key</span><span class="p">:</span> <span class="n">city</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
            <span class="n">sort_key</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span>
            <span class="n">data_key</span><span class="p">:</span> <span class="n">weather_json</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># build a success string</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">success</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">DynamoDB write success? I think so...&lt;/br&gt;</span><span class="s2">&#34;</span>

    <span class="c1"># S3</span>
    <span class="c1"># keeping this mega simple. This will write a file with the name: timestamp_city.csv to your bucket.</span>
    <span class="c1"># overwites are possible and im not trying to append.</span>
    <span class="c1"># pandas and AWS make it very easy to write csv</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">severless-ml-tutorial</span><span class="s2">&#34;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">_</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">city</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2"> </span><span class="s2">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">_</span><span class="s2">&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">.csv</span><span class="s2">&#34;</span>
    <span class="n">weather_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">s3://</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">bucket_name</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">/lambdas/</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># build a success string</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">success</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">S3 write success? I think so...&lt;/br&gt;</span><span class="s2">&#34;</span>

    <span class="c1"># send the output to the browser</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">statusCode</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="sa"></span><span class="s1">&#39;</span><span class="s1">body</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">headers</span><span class="s2">&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Content-Type</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">text/html</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Admittedly that was quite a long tutorial. Hopefully it has illustrated how a trained model can be incorporated into a larger codebase by using serverless functions. Enjoy.</p>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/20190111/pu_learning/" data-toggle="tooltip" data-placement="top" title="PU Learning">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>

                
<div id="disqus-comment"></div>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kabelsalat" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



            </div>
            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/data-science" title="data-science">
                            data-science
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/ggplot2" title="ggplot2">
                            ggplot2
                        </a>
                        
                        
                        
                        <a href="/tags/greyscale" title="greyscale">
                            greyscale
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/machine-learning" title="machine-learning">
                            machine-learning
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/r" title="r">
                            r
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/visualisation" title="visualisation">
                            visualisation
                        </a>
                        
                        
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>FRIENDS</h5>
                    <ul class="list-inline">
                        
                        <li><a target="_blank" href="https://medium.com/@kirshnee.m">Kirshnee Bhagwandas</a></li>
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                    
                    <li>
                        <a href="mailto:18571935&#43;philmassie@users.noreply.github.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/philmassie">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/philmassie">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://medium.com/@pmassie">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-medium fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Kabelsalat , 2019
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https'){
       bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else{
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>







<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-24074009-12', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>
</html>
